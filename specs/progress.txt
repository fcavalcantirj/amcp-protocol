# amcp-protocol Progress

## 2026-02-14: Identity schema validation (prd-v1 task 1)
- Created `packages/amcp-core/src/validate-identity.ts` — `validateIdentitySchema()` function
  - Validates flat format: requires aid (string), publicKey (string), privateKey (string)
  - Validates old agent format: requires agent.aid, agent.currentPublicKey, agent.currentPrivateKey
  - Rejects non-KERI AIDs (must start with Ed25519 prefix "B")
  - Rejects openclaw-deploy-style identities (sha256 AID, no KERI prefix)
  - Collects all errors (doesn't fail on first)
- Integrated into `loadIdentity()` in `scripts/amcp-cli.ts` (line 111)
  - Calls `validateIdentitySchema()` before format detection
  - Throws descriptive error on invalid identity with all collected errors
- Exported `validateIdentitySchema` and `IdentityValidationResult` from `@amcp/core` index
- Exported `isValidAid` from `@amcp/core` index (was missing)
- Added 17 test cases in `packages/amcp-core/src/test/validate-identity.test.ts`
- All 198 tests pass, build succeeds

## 2026-02-14: Ed25519 on-curve validation for isValidAid() (prd-v1 task 2)
- Updated `isValidAid()` in `packages/amcp-core/src/aid.ts`
  - Added `Point.fromBytes(publicKey, false)` — rejects bytes not on Ed25519 curve
  - Added `clearCofactor().equals(Point.ZERO)` — rejects small-order torsion points
  - Imported `Point` from `@noble/ed25519` (existing dependency)
- `isValidAid` was already exported from `@amcp/core` index.ts (task 1 did this)
- Added 11 test cases in `packages/amcp-core/src/test/aid-validation.test.ts`
  - Rejection: invalid curve points (y=2, y=7), torsion (all-zeros), 0xFF fill, wrong prefix, wrong length, empty, prefix-only, sha256 hex AID
  - Acceptance: real Ed25519 keypair AID, multiple generated AIDs
- All 209 tests pass, build succeeds

## 2026-02-14: 'amcp identity validate' CLI command (prd-v1 task 3)
- Created `validateIdentityFull()` in `packages/amcp-core/src/validate-identity.ts`
  - Composes all validation layers: schema check, AID Ed25519 on-curve check, AID-publicKey consistency, KEL integrity
  - Async function (KEL verification requires async crypto)
  - Returns `{ valid: boolean, errors: string[] }` with all collected errors
  - Skips KEL check when no KEL is present (flat CLI identities don't have KEL)
- Added `identity validate` subcommand to `scripts/amcp-cli.ts`
  - Accepts `--path` flag (defaults to `~/.amcp/identity.json`)
  - Outputs structured JSON: `{ valid: true }` or `{ valid: false, errors: [...] }`
  - Exit code 0 on valid, 1 on invalid — designed for scripting use
- Exported `validateIdentityFull` from `@amcp/core` index
- Added 12 test cases in `packages/amcp-core/src/test/validate-identity-full.test.ts`
  - Rejection: empty object, openclaw-deploy fake, invalid curve point, 0xFF fill, AID-publicKey mismatch, empty KEL, KEL AID mismatch
  - Acceptance: valid flat identity, valid with KEL, valid old-format, no KEL skips check, multi-error collection
- All 221 tests pass, build succeeds

## 2026-02-14: KEL integrity check in loadIdentity() (prd-v1 task 4)
- Upgraded `loadIdentity()` in `scripts/amcp-cli.ts` to use `validateIdentityFull()` instead of `validateIdentitySchema()`
  - Now runs all 4 validation layers on load: schema, AID crypto, AID-publicKey consistency, KEL integrity
  - Calls `verifyKEL()` via `validateIdentityFull()` — rejects corrupt/missing inception events
  - Made `loadIdentity()` async (required for `verifyKEL()` async crypto)
  - Updated all 3 call sites to `await loadIdentity()` (identity show, checkpoint create, resuscitate)
  - Removed unused `validateIdentitySchema` import (superseded by `validateIdentityFull`)
- Added 9 test cases in `packages/amcp-core/src/test/load-identity-kel.test.ts`
  - Rejection: empty KEL, missing inception (starts with rotation), wrong inception sn, corrupted signature, tampered AID, KEL AID mismatch
  - Acceptance: valid KEL from createAgent, identity without KEL, old-format with valid KEL
- All 230 tests pass, build succeeds
